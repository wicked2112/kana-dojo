name: Vercel Deployment Notifications

on:
  deployment_status:

permissions: {}

concurrency:
  group: vercel-deployment-status-${{ github.event.deployment.id }}-${{ github.event.deployment_status.state }}
  cancel-in-progress: true

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'failure' || github.event.deployment_status.state == 'error'

    steps:
      - name: Send Failure Notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOYMENT_ENV: ${{ github.event.deployment.environment }}
          DEPLOYMENT_REF: ${{ github.event.deployment.ref }}
          DEPLOYMENT_SHA: ${{ github.event.deployment.sha }}
          DEPLOYMENT_ID: ${{ github.event.deployment.id }}
          DEPLOYMENT_STATUS: ${{ github.event.deployment_status.state }}
          DEPLOYMENT_ERROR: ${{ github.event.deployment_status.description }}
          DEPLOYMENT_URL: ${{ github.event.deployment_status.target_url }}
          REPO: ${{ github.repository }}
          REPO_URL: ${{ github.event.repository.html_url }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
          ACTOR: ${{ github.actor }}
        run: |
          python3 << 'PY' > /tmp/payload.json
          import json
          import os
          from datetime import datetime, timezone

          deployment_env = os.environ.get("DEPLOYMENT_ENV", "unknown")
          is_prod = deployment_env == "production"
          title = f"ðŸš¨ Vercel Deploy Failed ({deployment_env})"
          color = 15158332 if is_prod else 15105570

          error = (os.environ.get("DEPLOYMENT_ERROR") or "No error description provided by the deployment status event.").strip()
          if len(error) > 900:
            error = error[:900] + "â€¦"

          repo = os.environ["REPO"]
          repo_url = os.environ["REPO_URL"]
          server_url = os.environ["SERVER_URL"]
          run_id = os.environ["RUN_ID"]
          ref = os.environ.get("DEPLOYMENT_REF", "unknown")
          sha = os.environ.get("DEPLOYMENT_SHA", "unknown")
          deployment_id = os.environ.get("DEPLOYMENT_ID", "unknown")
          status = os.environ.get("DEPLOYMENT_STATUS", "unknown")
          deployment_url = os.environ.get("DEPLOYMENT_URL") or "(no target_url)"
          actor = os.environ.get("ACTOR", "unknown")

          payload = {
            "embeds": [
              {
                "title": title,
                "description": "A deployment to Vercel has failed.",
                "color": color,
                "fields": [
                  {"name": "Repository", "value": repo, "inline": True},
                  {"name": "Environment", "value": deployment_env, "inline": True},
                  {"name": "Ref", "value": f"[`{ref}`]({server_url}/{repo}/tree/{ref})", "inline": False},
                  {"name": "Commit", "value": f"[`{sha}`]({repo_url}/commit/{sha})", "inline": False},
                  {"name": "Deployment", "value": f"ID: `{deployment_id}`\n{server_url}/{repo}/deployments", "inline": False},
                  {"name": "Status", "value": status, "inline": True},
                  {"name": "Error", "value": error, "inline": False},
                  {"name": "Deployment URL", "value": deployment_url, "inline": False},
                  {"name": "Workflow Run", "value": f"{server_url}/{repo}/actions/runs/{run_id}", "inline": False},
                  {"name": "Triggered by", "value": actor, "inline": True},
                ],
                "timestamp": datetime.now(timezone.utc).isoformat(),
              }
            ]
          }

          print(json.dumps(payload))
          PY

          echo "Payload:"
          cat /tmp/payload.json
          echo ""
          echo "Sending to Discord..."
          curl -sf -H "Content-Type: application/json" -X POST -d @/tmp/payload.json "$DISCORD_WEBHOOK"

  notify-success:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' && github.event.deployment.environment == 'production'

    steps:
      - name: Send Success Notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEPLOYMENT_ENV: ${{ github.event.deployment.environment }}
          DEPLOYMENT_REF: ${{ github.event.deployment.ref }}
          DEPLOYMENT_SHA: ${{ github.event.deployment.sha }}
          DEPLOYMENT_ID: ${{ github.event.deployment.id }}
          DEPLOYMENT_URL: ${{ github.event.deployment_status.target_url }}
          REPO: ${{ github.repository }}
          REPO_URL: ${{ github.event.repository.html_url }}
          SERVER_URL: ${{ github.server_url }}
          RUN_ID: ${{ github.run_id }}
        run: |
          python3 << 'PY' > /tmp/payload.json
          import json
          import os
          from datetime import datetime, timezone

          deployment_env = os.environ.get("DEPLOYMENT_ENV", "unknown")
          repo = os.environ["REPO"]
          repo_url = os.environ["REPO_URL"]
          server_url = os.environ["SERVER_URL"]
          run_id = os.environ["RUN_ID"]
          ref = os.environ.get("DEPLOYMENT_REF", "unknown")
          sha = os.environ.get("DEPLOYMENT_SHA", "unknown")
          deployment_id = os.environ.get("DEPLOYMENT_ID", "unknown")
          deployment_url = os.environ.get("DEPLOYMENT_URL") or "(no target_url)"

          payload = {
            "embeds": [
              {
                "title": f"âœ… Vercel Deploy Succeeded ({deployment_env})",
                "description": "Production deployment completed successfully.",
                "color": 3066993,
                "fields": [
                  {"name": "Repository", "value": repo, "inline": True},
                  {"name": "Environment", "value": deployment_env, "inline": True},
                  {"name": "Ref", "value": f"[`{ref}`]({server_url}/{repo}/tree/{ref})", "inline": False},
                  {"name": "Commit", "value": f"[`{sha}`]({repo_url}/commit/{sha})", "inline": False},
                  {"name": "Deployment", "value": f"ID: `{deployment_id}`\n{server_url}/{repo}/deployments", "inline": False},
                  {"name": "Deployment URL", "value": deployment_url, "inline": False},
                  {"name": "Workflow Run", "value": f"{server_url}/{repo}/actions/runs/{run_id}", "inline": False},
                ],
                "timestamp": datetime.now(timezone.utc).isoformat(),
              }
            ]
          }

          print(json.dumps(payload))
          PY

          echo "Payload:"
          cat /tmp/payload.json
          echo ""
          echo "Sending to Discord..."
          curl -sf -H "Content-Type: application/json" -X POST -d @/tmp/payload.json "$DISCORD_WEBHOOK"

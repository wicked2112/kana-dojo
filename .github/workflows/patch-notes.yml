name: KanaDojo Patch Notes

on:
  push:
    branches:
      - main
      - feature/discord-patch-notes
    paths:
      - features/PatchNotes/patchNotesData.json
  workflow_dispatch:

permissions:
  contents: read

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Send patch notes to Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          const { URL } = require('url');

          async function sendPatchNotes() {
            try {
              if (!process.env.WEBHOOK_URL) {
                console.log('No DISCORD_WEBHOOK secret configured; skipping');
                process.exit(0);
              }

              const patchNotes = JSON.parse(
                fs.readFileSync('./features/PatchNotes/patchNotesData.json', 'utf8')
              );

              if (!patchNotes || patchNotes.length === 0) {
                console.log('ðŸ“­ No patch notes found');
                process.exit(0);
              }

              const latest = patchNotes[0];
              const embedColor = 0x7C73E6;

              const categorized = { features: [], improvements: [], fixes: [], other: [] };

              latest.changes.forEach(change => {
                const lower = change.toLowerCase();
                if (lower.includes('new ') || lower.includes('added ')) categorized.features.push(change);
                else if (lower.includes('improve') || lower.includes('enhanced') || lower.includes('polished')) categorized.improvements.push(change);
                else if (lower.includes('fix') || lower.includes('fixed')) categorized.fixes.push(change);
                else categorized.other.push(change);
              });

              let description = '';

              if (categorized.features.length) {
                description += '**âœ¨ New Features**\n';
                categorized.features.forEach(f => { description += `â€¢ ${f}\n`; });
                description += '\n';
              }

              if (categorized.improvements.length) {
                description += '**âš¡ Improvements**\n';
                categorized.improvements.forEach(i => { description += `â€¢ ${i}\n`; });
                description += '\n';
              }

              if (categorized.fixes.length) {
                description += '**ðŸ› Bug Fixes**\n';
                categorized.fixes.forEach(f => { description += `â€¢ ${f}\n`; });
                description += '\n';
              }

              if (categorized.other.length) {
                description += '**ðŸ“ Other Changes**\n';
                categorized.other.forEach(o => { description += `â€¢ ${o}\n`; });
              }

              if (description.length > 4096) {
                description = `${description.substring(0, 4090)}...\n\n*See full changelog on GitHub*`;
              }

              const embed = {
                title: `ðŸŽŒ KanaDojo ${latest.version}`,
                description: description.trim(),
                color: embedColor,
                timestamp: new Date().toISOString(),
                footer: { text: `ã‹ãªé“å ´ â€¢ ${latest.date}`, icon_url: 'https://raw.githubusercontent.com/lingdojo/kana-dojo/main/public/kanadojo.png' },
                author: { name: 'KanaDojo Release', url: 'https://kanadojo.com', icon_url: 'https://raw.githubusercontent.com/lingdojo/kana-dojo/main/public/kanadojo.png' }
              };

              const payload = {
                content: `ðŸŽŠ @everyone **New update available!** KanaDojo ${latest.version} is now live.`,
                embeds: [embed],
                username: 'KanaDojo',
                avatar_url: 'https://raw.githubusercontent.com/lingdojo/kana-dojo/main/public/kanadojo.png'
              };

              const webhookUrl = new URL(process.env.WEBHOOK_URL);
              const data = JSON.stringify(payload);

              const options = {
                hostname: webhookUrl.hostname,
                path: webhookUrl.pathname + webhookUrl.search,
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(data) }
              };

              const req = https.request(options, (res) => {
                console.log(`Discord webhook status: ${res.statusCode}`);
                let body = '';
                res.on('data', chunk => body += chunk);
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('Patch notes sent successfully to Discord!');
                    console.log(`Version: ${latest.version}`);
                    console.log(`Date: ${latest.date}`);
                    console.log(`Changes: ${latest.changes.length} items`);
                  } else {
                    console.error('Discord API error:', body);
                    process.exit(1);
                  }
                });
              });

              req.on('error', (error) => {
                console.error('Request failed:', error.message);
                process.exit(1);
              });

              req.write(data);
              req.end();
            } catch (error) {
              console.error('Error processing patch notes:', error.message);
              process.exit(1);
            }
          }

          sendPatchNotes();
          EOF

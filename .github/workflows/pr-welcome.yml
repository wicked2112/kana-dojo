name: Welcome PR Authors

on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  welcome:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.pull_request.head.ref, 'automation/') }}

    steps:
      - name: Checkout for templates
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Post welcome comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const templates = require('./.github/templates/messages.cjs');
            const t = templates.prWelcome;

            const pr = context.payload.pull_request;
            const author = pr.user.login;

            let isFirstTime = false;
            try {
              let found = false;
              let page = 1;
              const MAX_PAGES = 10;
              while (page <= MAX_PAGES) {
                const { data: contributions } = await github.rest.repos.listContributors({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 100,
                  page: page
                });
                if (!contributions || contributions.length === 0) {
                  break;
                }
                found = contributions.some(function(c) { return c.login === author; });
                if (found) {
                  break;
                }
                if (contributions.length < 100) {
                  break;
                }
                page += 1;
              }
              isFirstTime = !found;
            } catch (e) {
              console.log(`Could not fetch contributors list: ${e.message}`);
            }

            const checklist = t.checklist.items.map(function(item) {
              return '- [ ] ' + item;
            }).join('\n');

            let welcomeMessage = `${t.greeting.replace('{author}', author)}\n\n${t.body}\n\n${t.checklist.title}\n${checklist}\n\n${t.footer}\n\n${t.thanks}`;

            if (isFirstTime) {
              welcomeMessage += `\n\n${t.firstTimeContributor.separator}\n\n${t.firstTimeContributor.title} ${t.firstTimeContributor.body}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: welcomeMessage
            });

            console.log(`Welcomed PR author @${author} on PR #${pr.number}`);
